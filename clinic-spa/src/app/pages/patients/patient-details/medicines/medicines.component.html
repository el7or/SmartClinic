<nb-card>
  <nb-card-body [nbSpinner]="formLoading" nbSpinnerStatus="success">
    <form #form="ngForm" aria-labelledby="title">
      <h6 langg>Add Prescription:</h6>
      <table class="table mb-1">
        <tbody>
          <tr *ngFor="let item of newPatientPrescription.medicines; index as i;">
            <td>
              <input nbInput [(ngModel)]="item.medicineName" [typeahead]="medicineValues" typeaheadOptionField="text"
                (typeaheadOnSelect)="onSelectMedicine($event,i)" (typeaheadNoResults)="item.isNameValid = !$event"
                (keyup)="!item.isNameValid || item.medicineName==''? isAnyNameInvalid = true : isAnyNameInvalid = false"
                [placeholder]="'Medication Name' | langg" [isAnimated]="true" [typeaheadMinLength]="0"
                [ngModelOptions]="{standalone: true}" class="leftAutoComplete"
                [typeaheadScrollable]="true" [typeaheadOptionsInScrollableView]="15" fieldSize="small" fullWidth>
              <ng-container *ngIf="!item.isNameValid && item.medicineName != ''">
                <label class="error-message" langg>This Name does not exist! Do you add it to the
                  list?</label>&nbsp;
                <button nbButton type="button" (click)="onAddNewItemToList(item);item.isNameValid=true" status="info"
                  size="small" class="mt-2" langg>Add</button>
              </ng-container>
            </td>
            <td>
              <nb-select fullWidth [(ngModel)]="item.quantityId" [ngModelOptions]="{standalone: true}"
                [placeholder]="'Quantity' | langg" size="small">
                <nb-option *ngFor="let item of quantityValues" [value]="item.id">{{item.text}}</nb-option>
              </nb-select>
            </td>
            <td>
              <nb-select fullWidth [(ngModel)]="item.doseId" [ngModelOptions]="{standalone: true}"
                [placeholder]="'Dose' | langg" size="small">
                <nb-option *ngFor="let item of doseValues" [value]="item.id">{{item.text}}</nb-option>
              </nb-select>
            </td>
            <td>
              <nb-select fullWidth [(ngModel)]="item.timingId" [ngModelOptions]="{standalone: true}"
                [placeholder]="'Timing' | langg" size="small">
                <nb-option *ngFor="let item of timingValues" [value]="item.id">{{item.text}}</nb-option>
              </nb-select>
            </td>
            <td>
              <nb-select fullWidth [(ngModel)]="item.periodId" [ngModelOptions]="{standalone: true}"
                [placeholder]="'Period' | langg" size="small">
                <nb-option *ngFor="let item of periodValues" [value]="item.id">{{item.text}}</nb-option>
              </nb-select>
            </td>
            <td>
              <button (click)="onRemoveMedicine(i)" nbButton [nbTooltip]="'Remove Medicine' | langg" size="tiny"
                status="danger" [hidden]="item== newPatientPrescription.medicines[0]">
                <nb-icon icon="close-square"></nb-icon>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <button (click)="onAddMedicine()" nbButton size="small" class="mb-1"
        [disabled]="newPatientPrescription.medicines.length && !newPatientPrescription.medicines[newPatientPrescription.medicines.length-1].medicineId">
        <nb-icon icon="plus"></nb-icon>
      </button>
      <div class="form-control-group">
        <textarea nbInput [(ngModel)]="newPatientPrescription.note" #note="ngModel" name="note"
          [placeholder]="'Other Notes ...' | langg" fullWidth></textarea>
      </div>
      <div class="form-control-group form-inline">
        <h6 langg>Send to Pharmacy:</h6>
        <nb-select [(ngModel)]="doctorPharmacyId" [ngModelOptions]="{standalone: true}"
          [placeholder]="'Pharmacy Name' | langg" size="small" fullWidth class="col-md-4 col-sm-6">
          <nb-option *ngFor="let item of pharmacyValues" [value]="item.id">{{item.text}}</nb-option>
        </nb-select>
      </div>

      <!-- <div class="form-control-group">
        <label for="input-newMedicine" class="label"><span langg>Add a new non-existing Medication Name to the list
            above</span>:</label>&nbsp;
        <input nbInput ngModel #newMedicine="ngModel" type="text" [placeholder]="'New Medication Name' | langg"
          fieldSize="small" [ngModelOptions]="{standalone: true}">&nbsp;
        <button nbButton type="button" (click)="onAddNewMedicinetoList(newMedicine)" [disabled]="!newMedicine.value"
          status="info" size="small" langg>Add</button>
      </div> -->

      <div class="text-center nbButton-group mb-1">
        <button nbButton type="submit" status="success" (click)="onSave(false)"
          [disabled]="!newPatientPrescription.medicines.length || (newPatientPrescription.medicines.length && !newPatientPrescription.medicines[newPatientPrescription.medicines.length-1].medicineId)"
          langg>Save</button>
        <button nbButton type="submit" status="success" (click)="onSave(true)"
          [disabled]="isAnyNameInvalid || !newPatientPrescription.medicines[newPatientPrescription.medicines.length-1].medicineId"
          langg>Save
          &
          Print</button>
        <button nbButton type="button" status="danger" (click)="location.back()" langg>Cancel</button>
      </div>
    </form>


    <h6 langg>Past Prescriptions:</h6>
    <table class="table table-bordered">
      <thead class="thead-dark">
        <tr>
          <th langg>Date</th>
          <th langg>Medicines</th>
          <th></th>
        </tr>
      </thead>
      <tbody *ngIf="!prevPatientPrescriptions?.length">
        <tr>
          <td colspan="3" class="text-center">
            <h5 langg>No Results !</h5>
          </td>
        </tr>
      </tbody>
      <tbody *ngIf="prevPatientPrescriptions?.length">
        <tr *ngFor="let item of prevPatientPrescriptions">
          <td>{{item.createdOn | localDateShort}}</td>
          <td>{{item.medicinesNames}}</td>
          <td class="text-center">
            <button nbButton type="button" status="success" size="small" (click)="onReOpen(item,'edit')"
              langg>Edit</button>&nbsp;
            <button nbButton type="button" status="info" size="small" (click)="onReOpen(item,'copy')"
              langg>Copy</button>&nbsp;
            <button nbButton type="button" status="basic" size="small" (click)="onPrint(item)" langg>Print</button>
          </td>
        </tr>
      </tbody>
    </table>
  </nb-card-body>
</nb-card>

<swal #doneSwal [title]="'Success' | langg" [text]="'Done successfully!' | langg" icon="success" timer="2000"
  [showConfirmButton]="false">
</swal>
